<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Simulador</title>

<style>
body{
    background:#0b132b;
    color:white;
    font-family:Arial;
    text-align:center;
}

button{
    margin:4px;
    padding:6px 12px;
}

#mapCanvas{
    border:2px solid white;
    margin-top:10px;
}
</style>
</head>

<body>

<h2>Simulador de Probabilidades</h2>

<button onclick="addPlayer()">Añadir jugador</button>
<button onclick="manualRound()">Ronda Manual</button>
<button onclick="toggleAuto()">Auto</button>
<button onclick="resetGame()">Reset</button>

<div id="players"></div>
<div id="info"></div>

<canvas id="mapCanvas" width="800" height="400"></canvas>

<script>
/* =========================
   CONFIGURACIÓN DEL MAPA
========================= */

const MAP_W = 40;
const MAP_H = 20;
const CELL_SIZE = 20;

let canvas = document.getElementById("mapCanvas");
let ctx = canvas.getContext("2d");

/* =========================
   DATOS
========================= */

let players = [];
let round = 0;
let auto = false;
let autoInterval = null;
let map = [];

/* =========================
   COLORES ARCOIRIS
========================= */

function getColor(i,total){
    let hue = (i * 360 / total);
    return `hsl(${hue},70%,55%)`;
}

/* =========================
   JUGADORES
========================= */

function addPlayer(){
    let id = players.length + 1;
    players.push({
        name:"J"+id,
        wins:0,
        weight:1,
        color:"#fff"
    });
    updatePlayers();
    initMap();
}

function updatePlayers(){
    let div = document.getElementById("players");
    div.innerHTML="";

    players.forEach((p,i)=>{
        p.color = getColor(i,players.length);

        div.innerHTML += `
        ${p.name}
        <button onclick="changeWeight(${i},1)">+</button>
        <button onclick="changeWeight(${i},-1)">-</button>
        Peso:${p.weight}
        <br>`;
    });
}

/* =========================
   MAPA INICIAL EN BLOQUES
========================= */

function initMap(){
    map = [];

    if(players.length==0) return;

    let blockWidth = Math.floor(MAP_W / players.length);

    for(let y=0;y<MAP_H;y++){
        map[y]=[];
        for(let x=0;x<MAP_W;x++){
            let owner = Math.floor(x / blockWidth);
            if(owner >= players.length) owner = players.length-1;
            map[y][x] = owner;
        }
    }

    drawMap();
}

/* =========================
   DIBUJAR MAPA
========================= */

function drawMap(){
    for(let y=0;y<MAP_H;y++){
        for(let x=0;x<MAP_W;x++){
            let owner = map[y][x];
            ctx.fillStyle = players[owner]?.color || "#000";
            ctx.fillRect(x*CELL_SIZE,y*CELL_SIZE,CELL_SIZE,CELL_SIZE);
        }
    }

    showTerritoryPercent();
}

/* =========================
   PORCENTAJES
========================= */

function showTerritoryPercent(){
    let counts = new Array(players.length).fill(0);

    for(let y=0;y<MAP_H;y++){
        for(let x=0;x<MAP_W;x++){
            counts[map[y][x]]++;
        }
    }

    let total = MAP_W * MAP_H;

    let text = "Territorio: ";
    counts.forEach((c,i)=>{
        let percent = ((c/total)*100).toFixed(1);
        text += `${players[i].name} ${percent}% | `;
    });

    document.getElementById("info").innerText = 
        `Rondas: ${round} \n${text}`;

    // detectar ganador total
    counts.forEach((c,i)=>{
        if(c == total){
            stopAuto();
            alert(players[i].name + " conquistó todo el mapa!");
        }
    });
}

/* =========================
   EXPANSIÓN DESDE BORDES
========================= */

function expandTerritory(winner){

    let expansions = 5; // velocidad de expansión

    for(let k=0;k<expansions;k++){

        let edges = [];

        for(let y=0;y<MAP_H;y++){
            for(let x=0;x<MAP_W;x++){
                if(map[y][x] == winner){

                    let dirs = [
                        [1,0],[-1,0],[0,1],[0,-1]
                    ];

                    dirs.forEach(d=>{
                        let nx = x+d[0];
                        let ny = y+d[1];

                        if(nx>=0 && ny>=0 && nx<MAP_W && ny<MAP_H){
                            if(map[ny][nx] != winner){
                                edges.push([nx,ny]);
                            }
                        }
                    });
                }
            }
        }

        if(edges.length>0){
            let pick = edges[Math.floor(Math.random()*edges.length)];
            map[pick[1]][pick[0]] = winner;
        }
    }
}

/* =========================
   PROBABILIDAD
========================= */

function getWinner(){
    let total = players.reduce((s,p)=>s+p.weight,0);
    let r = Math.random()*total;
    let sum = 0;

    for(let i=0;i<players.length;i++){
        sum += players[i].weight;
        if(r <= sum) return i;
    }
}

/* =========================
   RONDAS
========================= */

function manualRound(){
    if(players.length<2) return;

    round++;

    let winner = getWinner();
    players[winner].wins++;

    expandTerritory(winner);
    drawMap();
}

/* =========================
   AUTO
========================= */

function toggleAuto(){
    if(auto){
        stopAuto();
    }else{
        autoInterval = setInterval(manualRound,300);
        auto = true;
    }
}

function stopAuto(){
    clearInterval(autoInterval);
    auto = false;
}

/* =========================
   PESO
========================= */

function changeWeight(i,val){
    players[i].weight += val;
    if(players[i].weight < 1) players[i].weight = 1;
    updatePlayers();
}

/* =========================
   RESET
========================= */

function resetGame(){
    round = 0;
    players.forEach(p=>p.wins=0);
    initMap();
}

/* =========================
   INICIO
========================= */

initMap();

</script>
</body>
</html>
