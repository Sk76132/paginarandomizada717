<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dice Arena - Conquista</title>
<style>
body { background:#0f1220; color:white; font-family:Arial; text-align:center;}
.container { width:90%; max-width:900px; margin:auto; }
input { margin:5px; padding:4px; }
button { margin:3px; padding:4px 8px; border:none; border-radius:4px; cursor:pointer;}
button.gris { background:#888; color:white;}
#tabla { background:#161a2e; border:1px solid #333; padding:10px; height:160px; overflow:auto; font-family:monospace; margin-top:10px;}
canvas { margin-top:10px; background:#161a2e; border:1px solid #333;}
.playerBox { margin:4px; }
</style>
</head>
<body>
<div class="container">
<h2>Dice Arena - Modo Conquista</h2>

Jugadores <input id="players" type="number" value="2" min="2">
Min <input id="min" type="number" value="1">
Max <input id="max" type="number" value="6">
Velocidad(ms) <input id="velocidad" type="number" value="500">
Limite rondas <input id="limite" type="number" value="0">

<button onclick="configurar()">Configurar</button>
<button onclick="resetCompleto()">Reset</button>
<button onclick="iniciarAuto()">Auto</button>
<button onclick="detenerAuto()">Detener</button>

<div id="nombres"></div>

<button class="gris" onclick="ejecutarRonda()">Ronda Manual</button>

<h3 id="info"></h3>
<h3 id="lider"></h3>
<p id="mensaje"></p>

<canvas id="territorio" width="400" height="200"></canvas>

<div id="tabla"></div>
</div>

<script>
// ---------------- VARIABLES ----------------
let jugadores=[], puntos=[], colores=[], pesos=[], rondas=0;
let intervalo=null;

// Territorio
let grid=[];
const GRID_W=20;
const GRID_H=10;

// --- CONECTOR PARA FUTURAS FUNCIONES ---
console.log("CONECTOR → puedes agregar funciones aquí");

// ---------------- UTIL ----------------
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function colorRandom(){ return "hsl(" + Math.floor(Math.random()*360) + ",70%,60%)"; }

// Dado con probabilidad modificada
function dadoPonderado(min,max,peso){
    let v=rand(min,max);
    if(Math.random() < (peso-1)*0.15){
        v=rand(max-1,max);
    }
    return v;
}

// ---------------- CONFIG ----------------
function configurar(){
    let n=parseInt(document.getElementById("players").value);
    jugadores=[]; puntos=[]; colores=[]; pesos=[]; rondas=0;

    let cont=document.getElementById("nombres");
    cont.innerHTML="";

    for(let i=0;i<n;i++){
        jugadores.push("J"+(i+1));
        puntos.push(0);
        colores.push(colorRandom());
        pesos.push(1);

        let div=document.createElement("div");
        div.className="playerBox";

        let input=document.createElement("input");
        input.value=jugadores[i];
        input.oninput=(e)=>jugadores[i]=e.target.value;

        let mas=document.createElement("button");
        mas.textContent="➕";
        mas.onclick=()=>{ pesos[i]++; };

        let menos=document.createElement("button");
        menos.textContent="➖";
        menos.onclick=()=>{ pesos[i]=Math.max(1,pesos[i]-1); };

        let label=document.createElement("span");
        label.id="peso"+i;
        label.textContent=" Peso:1 ";

        setInterval(()=>{ label.textContent=" Peso:"+pesos[i]+" "; },300);

        div.appendChild(input);
        div.appendChild(mas);
        div.appendChild(menos);
        div.appendChild(label);
        cont.appendChild(div);
    }

    document.getElementById("tabla").innerHTML="";
    inicializarTerritorio();
    actualizarInfo();
    dibujarTerritorio();
}

// ---------------- TERRITORIO ----------------
function inicializarTerritorio(){
    grid=[];
    let total=GRID_W*GRID_H;

    let pool=[];
    for(let i=0;i<jugadores.length;i++){
        for(let j=0;j<Math.floor(total/jugadores.length);j++){
            pool.push(i);
        }
    }

    while(pool.length<total){
        pool.push(rand(0,jugadores.length-1));
    }

    pool.sort(()=>Math.random()-0.5);

    let index=0;
    for(let y=0;y<GRID_H;y++){
        grid[y]=[];
        for(let x=0;x<GRID_W;x++){
            grid[y][x]=pool[index++];
        }
    }
}

function robarPixel(ganador){
    let candidatos=[];
    for(let y=0;y<GRID_H;y++){
        for(let x=0;x<GRID_W;x++){
            if(grid[y][x]!==ganador){
                candidatos.push({x,y});
            }
        }
    }

    if(candidatos.length===0) return;

    let c=candidatos[rand(0,candidatos.length-1)];
    grid[c.y][c.x]=ganador;
}

function dibujarTerritorio(){
    const canvas=document.getElementById("territorio");
    const ctx=canvas.getContext("2d");

    let cellW=canvas.width/GRID_W;
    let cellH=canvas.height/GRID_H;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    for(let y=0;y<GRID_H;y++){
        for(let x=0;x<GRID_W;x++){
            let j=grid[y][x];
            ctx.fillStyle=colores[j];
            ctx.fillRect(x*cellW,y*cellH,cellW,cellH);
        }
    }
}

// ---------------- RONDA ----------------
function ejecutarRonda(){
    let min=parseInt(document.getElementById("min").value);
    let max=parseInt(document.getElementById("max").value);
    let limite=parseInt(document.getElementById("limite").value);

    if(limite>0 && rondas>=limite){
        detenerAuto();
        finalizar();
        return;
    }

    let valores=[], mayor=-Infinity;
    for(let i=0;i<jugadores.length;i++){
        let v=dadoPonderado(min,max,pesos[i]);
        valores.push(v);
        if(v>mayor) mayor=v;
    }

    let ganadores=[];
    valores.forEach((v,i)=>{
        if(v===mayor){
            puntos[i]++;
            ganadores.push(i);
        }
    });

    // Solo roba territorio si hay un único ganador
    if(ganadores.length===1){
        robarPixel(ganadores[0]);
    }

    rondas++;

    let fila=document.createElement("div");
    valores.forEach((v,i)=>{
        let span=document.createElement("span");
        span.textContent=jugadores[i]+":"+v+" ";
        span.style.color=colores[i];
        if(v===mayor) span.style.fontWeight="bold";
        fila.appendChild(span);
    });

    document.getElementById("tabla").appendChild(fila);
    document.getElementById("tabla").scrollTop=99999;

    actualizarInfo();
    dibujarTerritorio();
}

// ---------------- INFO ----------------
function actualizarInfo(){
    let texto="Rondas:"+rondas+" | ";
    let maxP=Math.max(...puntos);
    let lideres=[];

    puntos.forEach((p,i)=>{
        texto+=jugadores[i]+":"+p+" ";
        if(p===maxP) lideres.push(jugadores[i]);
    });

    document.getElementById("info").innerText=texto;
    document.getElementById("lider").innerText="Lider: "+lideres.join(", ");
}

function finalizar(){
    let maxP=Math.max(...puntos);
    let ganador=puntos.indexOf(maxP);
    document.getElementById("mensaje").innerText=jugadores[ganador]+" ganó la partida";
}

// ---------------- AUTO ----------------
function iniciarAuto(){
    if(intervalo) return;
    let vel=parseInt(document.getElementById("velocidad").value);
    intervalo=setInterval(ejecutarRonda,vel);
}

function detenerAuto(){
    clearInterval(intervalo);
    intervalo=null;
}

function resetCompleto(){
    detenerAuto();
    configurar();
}

// Inicializar
configurar();
</script>
</body>
</html>
